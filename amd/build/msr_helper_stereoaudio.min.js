define(["jquery","core/log"],function(a,b){"use strict";return b.debug("PoodLL Stereo Audio Recorder Helper: initialising"),{scriptprocessornode:null,requestDataInvoked:!1,recordingLength:0,isPaused:!1,deviceSampleRate:44100,leftchannel:[],rightchannel:[],recording:!1,volume:null,audioInput:null,context:null,sampleRate:0,mimeType:0,isPCM:!1,numChannels:1,msr:null,audioctx:null,mediaStream:null,volumeGainNode:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b,c){this.msr=a,this.audioctx=c,this.mediaStream=b,this.deviceSampleRate=c.sampleRate,this.sampleRate=a.sampleRate||this.deviceSampleRate,this.mimeType=a.mimeType||"audio/wav",this.isPCM=this.mimeType.indexOf("audio/pcm")>-1,this.numChannels=a.audioChannels||2,this.misc()},misc:function(){var a=this,b=this.audioctx;this.volumeGainNode=b.createGain();var c=this.volumeGainNode;this.audioInput=b.createMediaStreamSource(this.mediaStream);var d=this.audioInput;d.connect(c);var e=this.msr.bufferSize||2048;0===this.msr.bufferSize&&(e=0);var f=null;if(b.createJavaScriptNode)f=b.createJavaScriptNode(e,this.numChannels,this.numChannels);else{if(!b.createScriptProcessor)throw"WebAudio API has no support on this browser.";f=b.createScriptProcessor(e,this.numChannels,this.numChannels)}this.bufferSize=f.bufferSize,this.requestDataInvoked=!1,this.scriptprocessornode=f,1===this.numChannels&&console.debug("All right-channels are skipped."),this.isPaused=!1,f.onaudioprocess=function(b){if(a.recording&&!a.requestDataInvoked&&!a.isPaused){var c=b.inputBuffer.getChannelData(0);if(a.leftchannel.push(new Float32Array(c)),2===a.numChannels){var d=b.inputBuffer.getChannelData(1);a.rightchannel.push(new Float32Array(d))}a.recordingLength+=a.bufferSize}},c.connect(this.msr.audioanalyser.core),this.msr.audioanalyser.core.connect(f),f.connect(b.destination)},record:function(){this.recording=!0,this.leftchannel.length=this.rightchannel.length=0,this.recordingLength=0},requestData:function(){if(!this.isPaused){if(0===this.recordingLength)return void(this.requestDataInvoked=!1);this.requestDataInvoked=!0;var a=this.leftchannel.slice(0),b=this.rightchannel.slice(0),c=this.recordingLength;this.leftchannel.length=this.rightchannel.length=[],this.recordingLength=0,this.requestDataInvoked=!1;var d=this.mergeBuffers(a,c),e=d;if(2===this.numChannels){var f=this.mergeBuffers(b,c);this.interleaved=this.interleave(d,f)}if(this.isPCM){var g=new Blob([this.convertoFloat32ToInt16(e)],{type:"audio/pcm"});return void this.msr.ondataavailable(g)}var h=new ArrayBuffer(44+2*e.length),i=new DataView(h);this.writeUTFBytes(i,0,"RIFF"),i.setUint32(4,44+2*e.length-8,!0),this.writeUTFBytes(i,8,"WAVE"),this.writeUTFBytes(i,12,"fmt "),i.setUint32(16,16,!0),i.setUint16(20,1,!0),i.setUint16(22,this.numChannels,!0),i.setUint32(24,this.sampleRate,!0),i.setUint32(28,this.sampleRate*this.numChannels*2,!0),i.setUint16(32,2*this.numChannels,!0),i.setUint16(34,16,!0),this.writeUTFBytes(i,36,"data"),i.setUint32(40,2*e.length,!0);for(var j=e.length,k=44,l=1,m=0;m<j;m++)i.setInt16(k,e[m]*(32767*l),!0),k+=2;var g=new Blob([i],{type:"audio/wav"});this.msr.ondataavailable(g)}},stop:function(){this.recording=!1,this.requestData(),this.audioInput.disconnect()},interleave:function(a,b){for(var c=a.length+b.length,d=new Float32Array(c),e=0,f=0;f<c;)d[f++]=a[e],d[f++]=b[e],e++;return d},mergeBuffers:function(a,b){for(var c=new Float32Array(b),d=0,e=a.length,f=0;f<e;f++){var g=a[f];c.set(g,d),d+=g.length}return c},writeUTFBytes:function(a,b,c){for(var d=c.length,e=0;e<d;e++)a.setUint8(b+e,c.charCodeAt(e))},convertoFloat32ToInt16:function(a){for(var b=a.length,c=new Int16Array(b);b--;)c[b]=65535*a[b];return c.buffer},pause:function(){this.isPaused=!0},resume:function(){this.isPaused=!1}}});