define(["jquery","core/log","filter_poodll/utils_amd","filter_poodll/MediaStreamRecorder","filter_poodll/adapter","filter_poodll/uploader","filter_poodll/timer","filter_poodll/poodll_basemediaskin","filter_poodll/poodll_burntrosemediaskin"],function(a,b,c,d,e,f,g,h,i){"use strict";return b.debug("PoodLL Media Recorder: initialising"),{instanceprops:[],skins:[],fetch_instanceprops:function(a){return this.instanceprops[a]},fetch_skin:function(a){return this.skins[a]},supports_current_browser:function(a){if("audio"!=a.mediatype&&"video"!=a.mediatype)return!1;var c=0==M.cfg.wwwroot.indexOf("https:")||0==M.cfg.wwwroot.indexOf("http://localhost");if(c&&navigator&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){var d=!1;switch(a.mediatype){case"audio":d=!0;break;case"video":var e=!(navigator.userAgent.indexOf("Edge")===-1||!navigator.msSaveBlob&&!navigator.msSaveOrOpenBlob);e||(d=!0)}return d&&b.debug("PoodLL Media Recorder: supports this browser"),d}return!1},embed:function(a,b){var c=this,d="filter_poodll_controlbar_"+b.widgetid;this.init_instance_props(d);var e=this.fetch_instanceprops(d);e.config=b,e.timeinterval=b.media_timeinterval,e.audiomimetype=b.media_audiomimetype,e.videorecordertype=b.media_videorecordertype,e.videocaptureheight=b.media_videocaptureheight;var h=this.init_skin(d,e.config.media_skin,e);switch(e.config.onuploadsuccess=function(a){c.onUploadSuccess(a,h)},e.config.onuploadfailure=function(a){c.onUploadFailure(a,h)},b.mediatype){case"audio":var i=h.fetch_preview_audio(b.media_skin);e.controlbar=this.fetch_controlbar_audio(a,d,i),e.uploader=f.clone(),e.uploader.init(a,b),this.register_events_audio(d);break;case"video":var i=h.fetch_preview_video(b.media_skin);e.controlbar=this.fetch_controlbar_video(a,d,i),e.uploader=f.clone(),e.uploader.init(a,b),this.register_events_video(d)}e.timer=g.clone(),e.timer.init(0,function(){e.controlbar.status.html(e.timer.fetch_display_time())})},init_instance_props:function(a){this.instanceprops[a]={},this.instanceprops[a].recorded_index=0,this.instanceprops[a].mediaRecorder=null,this.instanceprops[a].blobs=[],this.instanceprops[a].timeinterval=5e3,this.instanceprops[a].audiomimetype="audio/webm",this.instanceprops[a].videorecordertype="auto",this.instanceprops[a].videocapturewidth=320,this.instanceprops[a].videocaptureheight=240,this.instanceprops[a].controlbar="",this.instanceprops[a].previewvolume=1,this.instanceprops[a].timer={},this.instanceprops[a].uploader={},this.instanceprops[a].uploaded=!1},init_skin:function(a,b,c){switch(b){case"burntrose":this.skins[a]=i.clone();break;case"plain":case"standard":default:this.skins[a]=h.clone()}return this.skins[a].init(c,this),this.skins[a]},onUploadSuccess:function(a,c){b.debug("from poodllmediarecorder: uploadsuccess");var d="filter_poodll_controlbar_"+a;c.onUploadSuccess(d)},onUploadFailure:function(a,c){b.debug("from poodllmediarecorder: uploadfailure");var d="filter_poodll_controlbar_"+a;c.onUploadFailure(d)},onMediaError:function(a){console.error("media error",a)},captureUserMedia:function(a,b,c){navigator.mediaDevices.getUserMedia(a).then(b)["catch"](c)},do_start_audio:function(a,b,c){a.blobs=[],this.captureUserMedia(b,c,this.onMediaError)},do_start_video:function(a,b){},do_play_audio:function(a,d){if(a.blobs&&a.blobs.length>0)switch(b.debug("playing type:"+a.blobs[0].type),a.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(a.blobs,function(b){var c=URL.createObjectURL(b);d.src=c,d.controls=!0,d.volume=a.previewvolume,d.play()});break;case"video/webm":case"audio/ogg":case"audio/webm":default:var e=c.simpleConcatenateBlobs(a.blobs,a.blobs[0].type),f=URL.createObjectURL(e);d.src=f,d.controls=!0,d.volume=a.previewvolume,d.play();break;case"olddefault":c.concatenateBlobs(a.blobs,a.blobs[0].type,function(b){var c=URL.createObjectURL(b);d.src=c,d.controls=!0,d.volume=a.previewvolume,d.play()})}},do_play_video:function(a){},do_save_audio:function(a){if(a.blobs&&a.blobs.length>0){switch(a.blobs[0].type){case"audio/wav":c.concatenateWavBlobs(a.blobs,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)});break;case"audio/ogg":case"audio/webm":case"video/webm":default:var b=c.simpleConcatenateBlobs(a.blobs,a.blobs[0].type);a.uploader.uploadBlob(b,a.blobs[0].type);break;case"old default":c.concatenateBlobs(a.blobs,a.blobs[0].type,function(b){a.uploader.uploadBlob(b,a.blobs[0].type)})}a.uploaded=!0,a.controlbar.startbutton.attr("disabled",!0)}},do_save_video:function(a){},do_stop_audio:function(a){a.mediaRecorder.stop()},do_stop_video:function(a){},do_pause_audio:function(a){a.mediaRecorder.resume(),a.mediaRecorder.pause()},do_pause_video:function(a){},do_resume_audio:function(a){a.mediaRecorder.resume()},do_resume_video:function(a){},register_events_audio:function(a){var c=this.fetch_instanceprops(a),d=this.skins[a],e={audio:!0},f=function(e){b.debug("onmediasuccess"),c.mediaRecorder=new MediaStreamRecorder(e),c.mediaRecorder.mimeType=c.audiomimetype,c.mediaRecorder.audioChannels=1,c.mediaRecorder.start(c.timeinterval),b.debug(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){b.debug("we got blob"),c.blobs.push(a)},d.onMediaSuccess_audio(a)};d.register_controlbar_events_audio(f,e,a)},register_events_video:function(a){var c=this.fetch_instanceprops(a),d=this.skins[a],e={audio:!IsOpera&&!IsEdge,video:!0},f=function(e){c.mediaRecorder=new MediaStreamRecorder(e);var f=c.controlbar.preview[0];f.srcObject=e,f.controls=!1,f.volume=0,f.play(),"mediarec"===c.videorecordertype&&(c.mediaRecorder.recorderType=MediaRecorderWrapper),"webp"===c.videorecordertype&&(c.mediaRecorder.recorderType=WhammyRecorder),c.mediaRecorder.videoWidth=c.videocapturewidth,c.mediaRecorder.videoHeight=c.videocaptureheight,c.mediaRecorder.start(c.timeinterval),c.mediaRecorder.ondataavailable=function(a){c.blobs.push(a),b.debug("We got a blobby")},d.onMediaSuccess_video(a)};d.register_controlbar_events_video(f,e,a)},update_status:function(a){var b=this.fetch_instanceprops(a);b.controlbar.status.html(b.timer.fetch_display_time())},fetch_controlbar_audio:function(a,b,c){var d=(this.fetch_instanceprops(b),this.fetch_skin(b)),e=d.insert_controlbar_audio(a,b,c);return e},fetch_controlbar_video:function(a,b,c){var d=(this.fetch_instanceprops(b),this.fetch_skin(b)),e=d.insert_controlbar_video(a,b,c);return e}}});