define(["jquery","core/log","filter_poodll/upskin_plain"],function(a,b,c){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b,d){this.config=b,d?this.upskin=d:(this.upskin=c.clone(),this.upskin.init(b,a,!1,!1)),this.upskin.initControls(),this.registerEvents()},registerEvents:function(){var a=this;this.config.hermes&&this.config.hermes.on("fetch_upload_url",function(b){a.fetchNewUploadDetails()})},fetchNewUploadDetails:function(){var a="local_cpapi_fetch_upload_details",c=new XMLHttpRequest,d=this;c.onreadystatechange=function(a){if(4===this.readyState)if(200==c.status){var e=c.responseText,f=JSON.parse(e);if(f){if(f.returnCode>0){var g={};return g.id=d.config.id,g.type="error",g.code=f.returnCode,g.message=f.returnMessage,void d.config.hermes.postMessage(g)}d.config.allowedURL=f.allowedURL,d.config.posturl=f.postURL,d.config.filename=f.filename,d.config.s3filename=f.s3filename,d.config.s3root=f.s3root,d.config.cloudfilename=f.shortfilename,d.config.cloudroot=f.shortroot}else b.debug("error:"+f.message)}else b.debug("Not 200 response:"+c.status)};var e="wstoken="+this.config.wstoken+"&wsfunction="+a+"&moodlewsrestformat="+this.config.moodlewsrestformat+"&mediatype="+this.config.mediatype+"&parent="+this.config.parent+"&appid="+this.config.appid+"&owner="+this.config.owner+"&region="+this.config.region+"&expiredays="+this.config.expiredays+"&transcode="+this.config.transcode+"&transcoder="+this.config.transcoder+"&transcribe="+this.config.transcribe+"&subtitle="+this.config.subtitle+"&transcribelanguage="+this.config.language+"&transcribevocab="+this.config.transcribevocab+"&notificationurl="+this.config.notificationurl+"&sourcemimetype="+this.config.sourcemimetype,f=M.cfg.wwwroot+"/webservice/rest/server.php";c.open("POST",f,!0),c.setRequestHeader("Cache-Control","no-cache"),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.send(e)},uploadBlob:function(a,b){this.uploadFile(a,b)},extractFilename:function(a){var b="success<filename>",c=a.indexOf(b);if(c<1)return!1;var d=a.indexOf("</filename>"),e=a.substring(c+b.length,d);return e},fetchFileExtension:function(a){var b="";switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"audio/ogg":b="ogg";break;case"video/quicktime":b="mov";break;case"audio/mpeg3":b="mp3";break;case"audio/mp3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/m4a":case"audio/x-m4a":b="m4a";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/mp4":b="mp4";break;case"video/webm":b="webm";break;case"video/ogg":b="ogg"}return b},pokeFilename:function(c,d){var e="";return"undefined"!=typeof d.config.updatecontrol&&""!==d.config.updatecontrol&&(e=a('[id="'+d.config.updatecontrol+'"]')),e.length<1&&(e=a('[id="'+d.config.updatecontrol+'"]',window.parent.document)),e.length>0?(e.get(0).value=c,e.trigger("change"),!0):(b.debug("upload failed #2"),d.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror"),!1)},alertRecorderSuccess:function(a){this.config.hasOwnProperty("onuploadsuccess")&&this.config.onuploadsuccess(a)},alertRecorderFailure:function(a){this.config.hasOwnProperty("onuploadfailure")&&this.config.onuploadfailure(a)},completeAfterProcessing:function(c,d,e){this.upskin.showMessage(M.util.get_string("recui_awaitingconversion","filter_poodll"),"recui_awaitingconversion"),c.config.iframeembed&&(d=c.config.s3root+c.config.s3filename);var f={};f.type="awaitingprocessing",f.mediaurl=d,f.mediafilename=c.config.s3filename,f.sourcefilename=c.config.sourcefilename,f.sourcemimetype=c.config.sourcemimetype,f.s3root=c.config.s3root,f.id=c.config.id,f.updatecontrol=c.config.updatecontrol,c.config.transcribe&&(f.transcripturl=d+".txt",f.transcriptfilename=c.config.s3filename+".txt"),c.config.hermes.postMessage(f);var g=this;a.ajax({url:c.config.s3root+c.config.s3filename,method:"HEAD",cache:!1,error:function(){b.debug("403 errors are normal here, till the file arrives back from conversion"),setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e)},success:function(a,b,f){switch(f.status){case 200:g.doUploadCompleteCallback(c,d);break;default:setTimeout(function(){g.completeAfterProcessing(c,d,e+500)},e)}}})},doUploadCompleteCallback:function(a,b){a.config.iframeembed&&(b=a.config.s3root+a.config.s3filename);var c=new Array;if(c[0]=a.config.widgetid,c[1]="filesubmitted",c[2]=b,c[3]=a.config.updatecontrol,c[4]=a.config.s3filename,this.upskin.showMessage(M.util.get_string("recui_uploadsuccess","filter_poodll"),"recui_uploadsuccess"),a.config.iframeembed){var d={};d.type="filesubmitted",d.mediaurl=a.config.s3root+a.config.s3filename,d.mediafilename=a.config.s3filename,d.sourcefilename=a.config.sourcefilename,d.sourcemimetype=a.config.sourcemimetype,d.s3root=a.config.s3root,d.id=a.config.id,d.updatecontrol=a.config.updatecontrol,a.config.transcribe&&(d.transcripturl=a.config.s3root+a.config.s3filename+".txt",d.transcriptfilename=a.config.s3filename+".txt"),a.config.hermes.postMessage(d)}else a.config.callbackjs&&""!=a.config.callbackjs?"function"==typeof a.config.callbackjs?a.config.callbackjs(c):this.executeFunctionByName(a.config.callbackjs,window,c):a.pokeFilename(b,a)},postProcessUpload:function(c,d){var e=c.currentTarget;if(4==e.readyState)if(d.upskin.deactivateProgressSession(),a(window).off("beforeunload",this.preventPrematureLeaving),200==e.status){var f=d.config.filename;if(f||(f=d.extractFilename(e.responseText)),!f)return b.debug("upload failed #1"),void b.debug(e);d.config.iframeembed?this.completeAfterProcessing(d,f,1e3):this.doUploadCompleteCallback(d,f),this.alertRecorderSuccess(d.config.widgetid)}else b.debug("upload failed #3"),b.debug(e),d.upskin.showMessage(M.util.get_string("recui_uploaderror","filter_poodll"),"recui_uploaderror"),this.alertRecorderFailure(d.config.widgetid)},preventPrematureLeaving:function(){return M.util.get_string("recui_waitwaitstilluploading","filter_poodll")},uploadFile:function(b,c){var d=new XMLHttpRequest,e=this.config,f=this,g=this.fetchFileExtension(c);"undefined"==typeof e.iframeembed&&(e.iframeembed=!1);var h=e.using_s3;if(this.upskin.initProgressSession(d),a(window).on("beforeunload",this.preventPrematureLeaving),this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading"),f.config.sourcemimetype=c,f.config.sourcefilename=f.config.s3filename,d.onreadystatechange=function(a){h&&4===this.readyState&&(e.iframeembed?f.update_filenames(f,g):f.postprocess_s3_upload(f)),f.postProcessUpload(a,f)},h)d.open("put",e.posturl,!0),d.setRequestHeader("Content-Type","application/octet-stream"),d.send(b);else if(b instanceof Blob){var i=new window.FileReader;i.readAsDataURL(b),i.onloadend=function(){var a=i.result,b="datatype=uploadfile";b+="&paramone="+encodeURIComponent(a),b+="&paramtwo="+g,b+="&paramthree="+e.mediatype,b+="&requestid="+e.widgetid,b+="&contextid="+e.p2,b+="&component="+e.p3,b+="&filearea="+e.p4,b+="&itemid="+e.p5,d.open("POST",e.posturl,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.send(b)}}else{var j="datatype=uploadfile";j+="&paramone="+encodeURIComponent(b),j+="&paramtwo="+g,j+="&paramthree="+e.mediatype,j+="&requestid="+e.widgetid,j+="&contextid="+e.p2,j+="&component="+e.p3,j+="&filearea="+e.p4,j+="&itemid="+e.p5,d.open("POST",e.posturl,!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.send(j)}},uploadMultiPartFile:function(b,c){var d=new XMLHttpRequest,e=this.config,f=this,g=this.fetchFileExtension(c);"undefined"==typeof e.iframeembed&&(e.iframeembed=!1);var h=e.using_s3;this.upskin.initProgressSession(d),a(window).on("beforeunload",this.preventPrematureLeaving),this.upskin.showMessage(M.util.get_string("recui_uploading","filter_poodll"),"recui_uploading"),f.config.sourcemimetype=c,f.config.sourcefilename=f.config.s3filename,d.onreadystatechange=function(a){h&&4===this.readyState&&(e.iframeembed?f.update_filenames(f,g):f.postprocess_s3_upload(f)),f.postProcessUpload(a,f)},h&&(d.open("put",e.posturl,!0),d.setRequestHeader("Content-Type","application/octet-stream"),d.send(b))},update_filenames:function(a,b){var c=a.config;switch(c.mediatype){case"audio":a.config.sourcefilename=c.s3filename.replace(".mp3","."+b),c.transcode||(a.config.s3filename=a.config.sourcefilename,a.config.cloudfilename=a.config.s3filename);break;case"video":a.config.sourcefilename=c.s3filename.replace(".mp4","."+b),c.transcode||(a.config.s3filename=a.config.sourcefilename)}},postprocess_s3_upload:function(a){var b=a.config;const c=new FormData;c.append("datatype","handles3upload"),c.append("contextid",b.p2),c.append("component",b.p3),c.append("filearea",b.p4),c.append("itemid",b.p5),c.append("filename",b.filename),c.append("mediatype",b.mediatype),navigator.sendBeacon||(navigator.sendBeacon=function(a,b){window.fetch(a,{method:"POST",body:b,credentials:"include"})}),navigator.sendBeacon(M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",c)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)},dataURItoBlob:function(a,b){for(var c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b})},Output:function(a){this.upskin.showMessage(a,"recorderskinmsg")}}});