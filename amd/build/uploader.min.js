define(["jquery","core/log"],function(a,b){"use strict";return b.debug("Universal Uploader: initialising"),{config:null,clone:function(){return a.extend(!0,{},this)},init:function(a,b){this.config=b,this.insert_controls(a)},insert_controls:function(b){var c='<div id="'+this.config.widgetid+'_progress" class="p_progress x"><p></p></div>';c+='<div id="'+this.config.widgetid+'_messages" class="p_messages x"></div>',a(b).append(c)},uploadBlob:function(a,b){this.uploadFile(a,b)},extractFilename:function(a){var b="success<filename>",c=a.indexOf(b);if(c<1)return!1;var d=a.indexOf("</filename>"),e=a.substring(c+b.length,d);return e},createProgressBar:function(b,c){var d=!1,e=a("#"+c.config.widgetid+"_progress");if(e.length){var f=e.get(0);d=f.firstChild,null===d&&(d=f.appendChild(document.createElement("p"))),d.className="",d.style.display="block",d.style.backgroundPosition="100% 0",b.upload.addEventListener("progress",function(a){var b=parseInt(100-a.loaded/a.total*100);d.style.backgroundPosition=b+"% 0"},!1)}return d},fetchFileExtension:function(a){var b="";switch(a){case"image/jpeg":b="jpg";break;case"image/png":b="png";break;case"audio/wav":b="wav";break;case"video/quicktime":b="mov";break;case"audio/mpeg3":b="mp3";break;case"audio/webm":b="webm";break;case"audio/x-mpeg-3":b="mp3";break;case"audio/3gpp":b="3gpp";break;case"video/mpeg3":b="3gpp";break;case"video/mp4":b="mp4";break;case"video/webm":b="webm"}return b},pokeFilename:function(c,d){d.Output(M.util.get_string("recui_uploadsuccess","filter_poodll"));var e="";if("undefined"!=typeof d.config.updatecontrol&&""!==d.config.updatecontrol&&(e=a('[id="'+d.config.updatecontrol+'"]')),e.length>0)e.get(0).value=c;else{if(e=window.parent.document.getElementById(d.config.updatecontrol),!e)return b.debug("upload failed #2"),d.Output(M.util.get_string("recui_uploaderror","filter_poodll")),!1;e.value=c}return!0},alertRecorderSuccess:function(a){this.config.hasOwnProperty("onuploadsuccess")&&this.config.onuploadsuccess(a)},alertRecorderFailure:function(a){this.config.hasOwnProperty("onuploadfailure")&&this.config.onuploadfailure(a)},doCallback:function(a,b){if(a.config.callbackjs&&""!=a.config.callbackjs){var c=new Array;c[0]=a.config.widgetid,c[1]="filesubmitted",c[2]=b,c[3]=a.config.updatecontrol,this.Output(M.util.get_string("recui_uploadsuccess","filter_poodll")),this.executeFunctionByName(a.config.callbackjs,window,c)}else a.pokeFilename(b,a)},postProcessUpload:function(a,c){var d=a.currentTarget;if(4==d.readyState)if(200==d.status){var e=c.config.filename;if(e||(e=c.extractFilename(d.responseText)),!e)return b.debug("upload failed #1"),void b.debug(d);this.doCallback(c,e),this.alertRecorderSuccess(c.config.widgetid)}else b.debug("upload failed #3"),b.debug(d),c.Output(M.util.get_string("recui_uploaderror","filter_poodll")),this.alertRecorderFailure(c.config.widgetid)},uploadFile:function(a,b){var c=new XMLHttpRequest,d=this.config,e=this,f=this.fetchFileExtension(b),g=d.using_s3;if(this.createProgressBar(c,e),this.Output(M.util.get_string("recui_uploading","filter_poodll")),c.onreadystatechange=function(a){g&&4===this.readyState&&e.postprocess_s3_upload(e),e.postProcessUpload(a,e)},g)c.open("put",d.posturl,!0),c.setRequestHeader("Content-Type","application/octet-stream"),c.send(a);else if(a instanceof Blob){var h=new window.FileReader;h.readAsDataURL(a),h.onloadend=function(){var a=h.result,b="datatype=uploadfile";b+="&paramone="+encodeURIComponent(a),b+="&paramtwo="+f,b+="&paramthree="+d.mediatype,b+="&requestid="+d.widgetid,b+="&contextid="+d.p2,b+="&component="+d.p3,b+="&filearea="+d.p4,b+="&itemid="+d.p5,c.open("POST",d.posturl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.send(b)}}else{var i="datatype=uploadfile";i+="&paramone="+encodeURIComponent(a),i+="&paramtwo="+f,i+="&paramthree="+d.mediatype,i+="&requestid="+d.widgetid,i+="&contextid="+d.p2,i+="&component="+d.p3,i+="&filearea="+d.p4,i+="&itemid="+d.p5,c.open("POST",d.posturl,!0),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.setRequestHeader("Cache-Control","no-cache"),c.send(i)}},postprocess_s3_upload:function(b){var c=b.config,d=new XMLHttpRequest,e=this;d.onreadystatechange=function(){4===this.readyState&&200!=d.status&&(e.Output("Post Process s3 Upload Error:"+d.status),a("#"+e.config.widgetid+"_messages").show())};var f="datatype=handles3upload";f+="&contextid="+c.p2,f+="&component="+c.p3,f+="&filearea="+c.p4,f+="&itemid="+c.p5,f+="&filename="+c.filename,f+="&mediatype="+c.mediatype,d.open("POST",M.cfg.wwwroot+"/filter/poodll/poodllfilelib.php",!0),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),d.setRequestHeader("Cache-Control","no-cache"),d.send(f)},Output:function(b){var c=a("#"+this.config.widgetid+"_messages");c.text(b)},executeFunctionByName:function(a,b,c){for(var d=a.split("."),e=d.pop(),f=0;f<d.length;f++)b=b[d[f]];return b[e].call(this,c)},dataURItoBlob:function(a,b){for(var c=atob(a.split(",")[1]),d=new ArrayBuffer(c.length),e=new Uint8Array(d),f=0;f<c.length;f++)e[f]=c.charCodeAt(f);return new Blob([d],{type:b})}}});