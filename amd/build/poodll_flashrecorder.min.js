define(["jquery","core/log","filter_poodll/uploader","filter_poodll/lzflash"],function(a,b,c,d){"use strict";return b.debug("PoodLL Flash Recorder: initialising"),{instanceprops:[],fetch_instance_props:function(a){return this.instanceprops[a]},init_instance_props:function(a){var b={};b.savebutton=null,b.audiodatacontrol=null,b.config=null,b.uploader=null,this.instanceprops[a]=b},is_ie:function(){var a=!1,b=window.navigator.userAgent,c=b.indexOf("MSIE "),d=b.indexOf("Trident/"),e=b.indexOf("Edge/");return(c>-1||d>-1||e>-1)&&(a=!0),a},supports_current_browser:function(a){var c=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;return c?!1:"audio"!=a.mediatype?!1:(b.debug("PoodLL Flash Recorder: supports this browser"),!0)},embed:function(b,e){1==e.flashmp3_cloudbypass&&(e.posturl=e.cloudbypassurl,e.filename=!1,e.s3filename=!1,e.using_s3=!1),this.init_instance_props(e.widgetid);var f=this.fetch_instance_props(e.widgetid);f.ie=this.is_ie(),f.ie&&(e.flashmp3audio_widgetjson=e.flashmp3audio_widgetjson.replace("sendmethod=post","sendmethod=ajax")),f.config=e;var g=a.parseJSON(e.flashmp3audio_widgetjson);d.embed.swf(g);var h="";f.ie&&(h=' style="display: none" ');var i=e.widgetid+"_savebutton",j='<button id="'+i+'" type="button" class="poodll_save-recording"'+h+">"+M.util.get_string("recui_save","filter_poodll")+"</button>";a(b).append(j);var k=e.widgetid+"_adc",l='<input type="hidden" name="audiodatacontrol" id="'+k+'" value="" />';a(b).prepend(l),f.uploader=c.clone(),f.uploader.init(b,e),d.embed[e.widgetid].setCanvasAttribute("audiodatacontrol",k),f.savebutton=a("#"+i),f.audiodatacontrol=a("#"+k),this.registerevents(e.widgetid)},registerevents:function(a){var b=this.fetch_instance_props(a);b.audioblob=!1,b.savebutton.click(function(){var a=atob(b.audiodatacontrol.val()),c=a&&a.length>0;if(!c&&!b.audioblob)return b.uploader.Output(M.util.get_string("recui_nothingtosaveerror","filter_poodll")),!1;if(!b.audioblob&&c){for(var e=[],f=0;f<a.length;f++)e.push(a.charCodeAt(f));b.audioblob=new Blob([new Uint8Array(e)],{type:"audio/mpeg3"})}b.uploader.uploadBlob(b.audioblob,"audio/mpeg3");var g="poodllapi.mp3_disable()";return d.embed[b.config.widgetid].callMethod(g),b.audiodatacontrol.val(""),!1})}}});